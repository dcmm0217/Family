# 第7节-Redis的缓存过期淘汰策略

面试题：

- 生产上你们的redis内存设置多少？
- 如何配置、修改redis的内存大小
- 如果内存满了你怎么办？
- redis的key清理方式？定期删除和惰性删除有了解吗？
- redis缓存淘汰策略
- redis的lru了解过吗？

## 1、redis内存满了怎么办？

redis默认内存是多少？在哪里看？如何设置修改?

> 查看redis最大占用内存

![image-20220602171103797](https://mygiteepic.oss-cn-shenzhen.aliyuncs.com/img/image-20220602171103797.png)

redis配置文件，设置maxmemory参数，maxmemory是bytes字节类型，注意转换。

> redis默认内存多少可用？

如果不设置最大内存或设置最大内存为0，在64位操作系统下不限制内存大小 = 服务器最大内存上线（占用不满，其他应用也会占内存），在32位操作系统下最多使用3GB的内存

> 生产上如何配置？

**一般推荐Redis内存大小为设置物理内存的3/4**

> 如何修改redis内存设置

通过修改文件配置

![image-20220602171804986](https://mygiteepic.oss-cn-shenzhen.aliyuncs.com/img/image-20220602171804986.png)

通过命令去修改

```
config set maxmemory size(大小)

config get maxmemory
```

> 什么命令查看redis内存使用情况?

info memory

模拟redis内存打满的场景，redis使用内存超出最大限制，会怎样？

![image-20220602171940124](https://mygiteepic.oss-cn-shenzhen.aliyuncs.com/img/image-20220602171940124.png)

设置了maxmemory的选项，假如redis内存使用达到上限，会出现oom的错误

没有加上过期时间就会导致数据写满maxmemory，为了避免类似情况，引出下一章内存淘汰策略。

## 2、redis过期键的删除策略

> redis过期键的删除策略

三种不同的删除策略

立即删除

Redis不可能时时刻刻遍历所有被设置了生存时间的key，来检测数据是否已经到达过期时间，然后对它进行删除。

立即删除能保证内存中数据的最大新鲜度，因为它保证过期键值会在过期后马上被删除，其所占用的内存也会随之释放。但是立即删除对cpu是最不友好的。因为删除操作会占用cpu的时间，如果刚好碰上了cpu很忙的时候，比如正在做交集或排序等计算的时候，就会给cpu造成额外的压力，让CPU心累，时时需要删除，忙死。。。。。。。

这会产生大量的性能消耗，同时也会影响数据的读取操作。

总结：对CPU不友好，用处理器性能换存储空间（拿时间换空间）

惰性删除

数据到达过期时间，不做处理。等下次访问该数据时，
如果未过期，返回数据 ；
发现已过期，删除，返回不存在。

惰性删除策略的缺点是，它对内存是最不友好的。

如果一个键已经过期，而这个键又仍然保留在redis中，那么只要这个过期键不被删除，它所占用的内存就不会释放。

在使用惰性删除策略时，如果数据库中有非常多的过期键，而这些过期键又恰好没有被访问到的话，那么它们也许永远也不会被删除(除非用户手动执行FLUSHDB)，我们甚至可以将这种情况看作是一种内存泄漏–无用的垃圾数据占用了大量的内存，而服务器却不会自己去释放它们，这对于运行状态非常依赖于内存的Redis服务器来说,肯定不是一个好消息

总结：对memory不友好，用存储空间换取处理器性能（拿空间换时间）

定期删除

定期删除策略是前两种策略的折中：

**定期删除策略每隔一段时间执行一次删除过期键操作，并通过限制删除操作执行的时长和频率来减少删除操作对CPU时间的影响。**

周期性轮询redis库中的时效性数据，采用随机抽取的策略，利用过期数据占比的方式控制删除频度 

特点1：CPU性能占用设置有峰值，检测频度可自定义设置 

特点2：内存压力不是很大，长期占用内存的冷数据会被持续清理 

总结：周期性抽查存储空间 （随机抽查，重点抽查）

redis默认每个100ms检查，是否有过期的key，有过期key则删除。

注意：redis不是每隔100ms将所有的key检查一次而是**随机抽取进行检查**(如果每隔100ms,全部key进行检查，redis直接进去ICU)。因此，如果只采用定期删除策略，会导致很多key到时间没有删除。

定期删除策略的难点是确定删除操作执行的时长和频率：如果删除操作执行得太频繁，或者执行的时间太长，定期删除策略就会退化成立即删除策略，以至于将CPU时间过多地消耗在删除过期键上面。如果删除操作执行得太少，或者执行的时间太短，定期删除策略又会和惰性删除束略一样，出现浪费内存的情况。因此，如果采用定期删除策略的话，服务器必须根据情况，合理地设置删除操作的执行时长和执行频率。

2个步骤：定期抽样key，判断是否过期   +  会存在漏网之鱼

1 定期删除时，从来没有被抽查到

2 惰性删除时，也从来没有被点中使用过

 上述2步骤====>  大量过期的key堆积在内存中，导致redis内存空间紧张或者很快耗尽

 必须要有一个更好的兜底方案......  redis缓存淘汰策略

## 3、redis缓存淘汰策略

有哪些淘汰策略？

```
noeviction:不会驱逐任何key

allkeys-lru：对所有key使用LRU算法进行删除

volatile-lru：有所有设置了过期时间的key进行lru算法进行删除

allkeys-random：对所有key进行随机删除

volatile-random：有所有设置了过期时间的key随机删除

volatile-ttl：删除马上要过期了的key

allkeys-lfu：对所有key使用lfu算法进行删除

volatile-lfu：对所有设置了过期时间的key使用lfu算法进行删除
```

总结：2 * 4 = 8

2个维度  ：allkey   带有过期时间的key

4个方面：LRU LFU Random ttl

**平时用哪一种：allkeys-lru 一般不会出错**

如何配置、修改

命令 或者 配置文件修改

![image-20220603140229413](https://mygiteepic.oss-cn-shenzhen.aliyuncs.com/img/image-20220603140229413.png)

