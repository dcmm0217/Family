# 其他数据库日志

我们在讲解数据库事务时，讲过两种日志：`重做日志`(redo log)、`回滚日志`（undo log）。

对于线上数据库应用系统，突然遭遇`数据库宕机`，怎么办？在这种情况下，`定位宕机的原因`就非常关键。我们可以查看数据库的`错误日志`。因为日子中记录了数据库运行中的诊断信息，包括了`错误、警告和注释`等信息。

比如：从日志中发现某个连接中的SQL操作发生了死循环，导致内存不足，被系统强行终止了。明确了原因，处理起来也就轻松了，系统很快就恢复了运行。

除了发现错误，日志在数据复制，数据恢复，操作审计，以及确保数据的永久性和一致性等方面，都有着不可替代的作用。

**千万不要小看日志**。很多看似奇怪的问题，答案往往就藏在日志里。很多情况下，只有通过查看日志才能发现问题的原因，真正解决问题。所以，一定要学会查看日志，养成检查日志的习惯，对提升你的**数据库应用开发能力至关重要**

MySQL8.0 官网日志地址：“ https://dev.mysql.com/doc/refman/8.0/en/server-logs.html ”

## 1、MySQL支持的日志

#### 1.1 日志类型

MySQL有不同类型的日志文件，用来存储不同类型的日志，分为 `二进制日志` 、` 错误日志` 、 `通用查询日志`和 `慢查询日志` ，这也是**常用的4种**。MySQL 8又新增两种支持的日志： `中继日志` 和 `数据定义语句日志` 。

使用这些日志文件，可以查看MySQL内部发生的事情。

**这6类日志分别为：**

- `慢查询日志`：记录所有执行时间超过`long_query_time`的所有查询，方便我们对查询进行优化
- `通用查询日志`：记录所有连接的起始时间和终止时间，以及连接发送给数据库服务器的所有指令，**对我们复原操作的实际场景、发现问题，甚至是对数据库操作的审计都有很大的帮助**
- `错误日志`：记录MySQL服务的启动、运行或停止MySQL服务时出现的问题，方便我们了解服务器的状态，从而对服务器进行维护
- `二进制日志(bin log)`：记录所有**更改数据**的语句，==可以用于主从服务器之间的数据同步，以及服务器遇到故障时数据的无损失恢复==
- `中继日志（relay log）`：用于主从服务器架构中，从服务器用来存放主服务器二进制日志内容的一个中间文件。从服务器通过读取中继日志的内容，来同步主服务器上的操作。
- `数据定义语句日志`：记录数据定义语句执行的元数据操作。

除二进制日志外，其他日志都是 `文本文件` 。默认情况下，所有日志创建于 `MySQL数据目录` 中。

#### 1.2 日志的弊端

- 日志功能会`降低Mysql数据库的性能`。例如，在查询非常频繁的Mysql数据库系统中，如果开启了通用查询日志和慢查询日志，Mysql数据库会花费很多时间记录日志。
- 日志会`占用大量的磁盘空间`。对于用户量非常大、操作非常频繁的数据库，日志文件需要的存储空间设置比数据库文件需要的存储空间还要大。

## 2、慢查询日志（slow query log）

explain章节有讲过

## 3、通用查询日志（general query log）

通用查询日志用来 `记录用户的所有操作` ，包括启动和关闭MySQL服务、所有用户的连接开始时间和截止时间、发给 MySQL 数据库服务器的所有 SQL 指令等。当我们的数据发生异常时，**查看通用查询日志，还原操作时的具体场景，可以帮助我们准确定位问题。**

#### 3.1 问题场景

在电商系统中，购买商品并且使用微信支付完成以后，却发现支付中心的记录并没有新增，此时用户再次使用支付宝支付，就会出现`重复支付`的问题。但是去数据库查询数据的时候，会发现只有一条记录存在。那么此时给到的现象就是只有一条支付记录，但是用户却支付了两次。

我们对系统进行了仔细检查，没有发现数据问题，因为用户编号和订单编号以及第三方流水号都是对的。可是用户确实支付了两次，这个时候，我们想到**使用检查通用查询日志**，看看当天到底发生了什么。

查看之后发现：1月1日下午2点，用户使用微信支付完以后，但是由于网络故障，支付中心没有及时收到微信支付的回调通知，导致当时没有写入数据，1月1日下午2点30，用户又使用支付宝支付，此时记录更新道支付中心。1月1日晚上9点，微信的回调通知过来了，但是支付中心已经存在了支付宝的记录，所以只能覆盖记录了。

==由于网络原因导致了重复支付。至于解决问的方案就很多了，这里省略（做接口幂等即可）==

可以看到通用查询日志可以帮助我们了解操作发生的具体时间和操作的细节，对找出异常发生的原因极其关键。

#### 3.2 查看当前状态

```sql
mysql> SHOW VARIABLES LIKE '%general%';
+------------------+------------------------------+
| Variable_name | Value |
+------------------+------------------------------+
| general_log | OFF | #通用查询日志处于关闭状态
| general_log_file | /var/lib/mysql/atguigu01.log | #通用查询日志文件的名称是atguigu01.log
+------------------+------------------------------+
2 rows in set (0.03 sec)
```

说明1：系统变量 `general_log`的值时OFF，即通用查询日志处于关闭状态。在Mysql中，这个参数的`默认值时关闭的`。因为一旦开启记录通用查询日志，Mysql会记录所有的连接起止和相关SQL操作，这样会消耗系统资源并且占用磁盘空间。我们可以通过手动修改变量的值，在`需要的时候开启日志`。

说明2：通用查询日志的文件名是 hostname.log 。 存储路径/var/lib/mysql/，默认也是数据路径。这样我们就知道在哪里可以查看通用查询日志的内容了。

#### 3.3 启动日志

**方式1：永久性方式**

修改my.conf或者my.ini配置文件来设置。在[mysqld]组下加入log选项，并重启Mysql服务。格式如下：

```mysql
[mysqld]
general_log=ON
general_log_file=[path[filename]] #日志文件所在目录路径，filename为日志文件名
```

如果不指定目录和文件名，通用查询日志将默认存储在MySQL数据目录中的hostname.log文件中，
hostname表示主机名。

**方式2：临时性方式**

```sql
SET GLOBAL general_log=on; # 开启通用查询

SET GLOBAL general_log_file=’path/filename’; # 设置日志文件保存位置
```

对应的，关闭操作SQL命令如下：

```sql
SET GLOBAL general_log=off; # 关闭通用查询日志
```

查看设置后情况：

```sql
SHOW VARIABLES LIKE 'general_log%';
```

#### 3.4 查看日志

通用查询日志是以 `文本文件` 的形式存储在文件系统中的，可以使用 `文本编辑器 `直接打开日志文件。每台MySQL服务器的通用查询日志内容是不同的。

- 在Windows操作系统中，使用文本文件查看器；
- 在Linux系统中，可以使用vi工具或者gedit工具查看；
- 在Mac OSX系统中，可以使用文本文件查看器或者vi等工具查看。

从` SHOW VARIABLES LIKE 'general_log%';` 结果中可以看到通用查询日志的位置。

```log
/usr/sbin/mysqld, Version: 8.0.26 (MySQL Community Server - GPL). started with:
Tcp port: 3306 Unix socket: /var/lib/mysql/mysql.sock
Time Id Command Argument
2022-01-04T07:44:58.052890Z 10 Query SHOW VARIABLES LIKE '%general%'
2022-01-04T07:45:15.666672Z 10 Query SHOW VARIABLES LIKE 'general_log%'
2022-01-04T07:45:28.970765Z 10 Query select * from student
2022-01-04T07:47:38.706804Z 11 Connect root@localhost on using Socket
2022-01-04T07:47:38.707435Z 11 Query select @@version_comment limit 1
2022-01-04T07:48:21.384886Z 12 Connect root@172.16.210.1 on using TCP/IP
2022-01-04T07:48:21.385253Z 12 Query SET NAMES utf8
2022-01-04T07:48:21.385640Z 12 Query USE `atguigu12`
2022-01-04T07:48:21.386179Z 12 Query SHOW FULL TABLES WHERE Table_Type !=
'VIEW'
2022-01-04T07:48:23.901778Z 13 Connect root@172.16.210.1 on using TCP/IP
2022-01-04T07:48:23.902128Z 13 Query SET NAMES utf8
2022-01-04T07:48:23.905179Z 13 Query USE `atguigu`
2022-01-04T07:48:23.905825Z 13 Query SHOW FULL TABLES WHERE Table_Type !=
'VIEW'
2022-01-04T07:48:32.163833Z 14 Connect root@172.16.210.1 on using TCP/IP
2022-01-04T07:48:32.164451Z 14 Query SET NAMES utf8
2022-01-04T07:48:32.164840Z 14 Query USE `atguigu`
2022-01-04T07:48:40.006687Z 14 Query select * from account
```

在通用查询日志里面，我们可以清楚地看到，什么时候开启了新的客户端登陆数据库，登录之后做了什
么 SQL 操作，针对的是哪个数据表等信息。

#### 3.5 停止日志

**方式1：永久性方式**

修改` my.cnf `或者` my.ini `文件，把[mysqld]组下的 `general_log` 值设置为 `OF`F 或者把general_log一项注释掉。修改保存后，再 `重启MySQL服务` ，即可生效。 举例：

```mysql
[mysqld]
general_log=OFF

[mysqld]
#general_log=ON
```

**方式2：临时性方式**

使用SET语句停止MySQL通用查询日志功能：

```sql
SET GLOBAL general_log=off;
```

查询通用日志功能：

```sql
SHOW VARIABLES LIKE 'general_log%';
```

#### 3.6 删除/刷新日志

如果数据的使用非常频繁，那么通用查询日志会占用服务器非常大的磁盘空间。数据管理员可以删除很
长时间之前的查询日志，以保证MySQL服务器上的硬盘空间。

**手动删除文件**

```sql
SHOW VARIABLES LIKE 'general_log%';
```

可以看出，通用查询日志的目录默认为MySQL数据目录。在该目录下手动删除通用查询日志atguigu01.log

使用如下命令重新生成查询日志文件，具体命令如下。刷新MySQL数据目录，发现创建了新的日志文
件。前提一定要开启通用日志。

```sql
mysqladmin -uroot -p flush-logs
```

如果希望备份旧的通用查询日志，就必须先将旧的日志文件复制出来或者改名，然后执行上面的mysqladmin命令。流程如下

```sql
cd mysql-data-directory #输入自己的通用查询日志所在的目录
mv mysql.general.log mysql.general.log.old #指明旧的文件名 以及新的文件名
mysqladmin -uroot -p flush-logs
```

## 4、错误日志(error log)

错误日子记录了Mysql服务器启动、停止运行的时间，以及系统启动、运行和停止过程中的诊断信息，包括`错误`、`警告`和`提示`等。

通过错误日志可以查看系统的运行状态，便于即时发现故障、修复故障。如果Mysql服务`出现异常`，错误日志是发现问题、解决故障的`首选`。

#### 4.1 启动日志

在MySQL数据库中，错误日志功能是 `默认开启` 的。而且，**错误日志 无法被禁止** 。

默认情况下，错误日志存储在MySQL数据库的数据文件夹下，名称默认为` mysqld.log `（Linux系统）或`hostname.err` （mac系统）。如果需要**制定文件名，则需要在my.cnf或者my.ini中做如下配置：**

```sql
[mysqld]
log-error=[path/[filename]] #path为日志文件所在的目录路径，filename为日志文件名
```

修改配置项后，需要重启MySQL服务以生效。

#### 4.2 查看日志

MySQL错误日志是以文本文件形式存储的，可以使用文本编辑器直接

查询错误日志的存储路径：

```sql
mysql> SHOW VARIABLES LIKE 'log_err%';
+----------------------------+----------------------------------------+
| Variable_name | Value |
+----------------------------+----------------------------------------+
| log_error | /var/log/mysqld.log |
| log_error_services | log_filter_internal; log_sink_internal |
| log_error_suppression_list | |
| log_error_verbosity | 2 |
+----------------------------+----------------------------------------+
4 rows in set (0.01 sec)
```

执行结果中可以看到错误日志文件是mysqld.log，位于MySQL默认的数据目录下。

#### 4.3 删除\刷新日志

对于很久以前的错误日志，数据库管理员查看这些错误日志的可能性不大，可以将这些错误日志删除，
以保证MySQL服务器上的 `硬盘空间 `。MySQL的错误日志是以文本文件的形式存储在文件系统中的，可以`直接删除` 。

```sql
[root@atguigu01 log]# mysqladmin -uroot -p flush-logs
Enter password:
mysqladmin: refresh failed; error: 'Could not open file '/var/log/mysqld.log' forerror logging.'
```

官网提示：

![image-20220301213348209](https://gitee.com/huangwei0123/image/raw/master/img/image-20220301213348209.png)

补充操作：

```sql
install -omysql -gmysql -m0644 /dev/null /var/log/mysqld.log
# 先要去创建这个文件
```

`flush-logs`指令操作：

- Mysql5.5.7以前版本，flush-logs将错误日志文件重命名为filename.err_old，并创建新的日志文件。
- 从Mysql5.5.7开始，flush-logs只是重新打开日志文件，并不做日志备份和创建操作。
- 如果日志文件不存在，Mysql启动或者执行flush-logs时会自动创建新的日志文件。重新创建错误日志，大小为0字节。

#### 4.4 Mysql8.0新特性

Mysql里对错误日志的改进。Mysql8.0的错误日志可以理解成为一个全新的日志，在这个版本里，接受了来自社区的广泛批评意见，在这些意见和建议的基础上生成了新的日志。

下面这些事来自社区的意见：

- 默认情况下内容过于冗长
- 遗漏了有用的信息
- 难以过滤某些信息
- 没有标识错误信息的子系统源
- 没有错误代码，解析消息需要识别错误
- 引导消息可能会丢失
- 固定格式

针对这些意见，Mysql做了如下改变：

- 采用组件架构，通过不同的组件执行日志的写入和过滤功能
- 写入错误日志的全部信息都具有唯一的错误代码10000开始
- 增加了一个新的消息分类《system》用于在错误日志中始终可见的非错误但服务器状态更改事件的消息
- 增加了额外的附加信息，例如关机时的版本信息，谁发起的关机等。
- 两种过滤方式，Internal和Dragnet
- 三种写入形式、经典、JSON和syseventlog

> 小结：
>
> 通常情况下，管理员不需要查看错误日志。但是，Mysql服务器发生异常时，管理员可以从错误日志中找到发生异常的事件、原因，然后根据这些信息来解决异常。

## 5、二进制日志（bin log）

